#!/bin/bash
# imaginary-angel - Imaginary Linux System Guardian
# Version 1.0 (Shamshel)
# A comprehensive system security and maintenance tool

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

VERSION="1.0"
CODENAME="Shamshel"

# Get script directory (works from anywhere, even through symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, resolve it
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
MODULES_DIR="${SCRIPT_DIR}/modules"

# System directories
LOG_DIR="/var/log/imaginary-angel"
CACHE_DIR="/var/cache/imaginary-angel"
CONFIG_FILE="/etc/imaginary-angel.conf"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m'

# Box drawing characters (using standard ASCII that works everywhere)
readonly TL='┌'
readonly TR='┐'
readonly BL='└'
readonly BR='┘'
readonly H='─'
readonly V='│'

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

print_logo() {
  clear
  echo -e "${MAGENTA}"
  cat <<'EOF'
   ████▓▓▒▒      ▒▒▓▓████
  ████▓▓▓▒▒      ▒▒▓▓▓████
 ████▓▓▓▓▒▒      ▒▒▓▓▓▓████
████▓▓▓▓▒▒   ██   ▒▒▓▓▓▓████
███▓▓▓▒▒     ██     ▒▒▓▓▓███
██▓▓▒▒       ██       ▒▒▓▓██
█▓▒          ██          ▒▓█
▒                          ▒
EOF
  echo -e "${CYAN}      IMAGINARY ANGEL${NC}"
  echo -e "${GRAY}   System Guardian v${VERSION} (${CODENAME})${NC}"
  echo ""
}

draw_box() {
  local width=$1
  local title="${2:-}"

  echo -e -n "${CYAN}${TL}"
  if [ -n "$title" ]; then
    # Strip ANSI codes for length calculation
    local title_plain=$(echo -e "$title" | sed 's/\x1b\[[0-9;]*m//g')
    local title_len=${#title_plain}
    local padding=$(((width - title_len - 2) / 2))
    for ((i = 0; i < padding; i++)); do echo -n "${H}"; done
    echo -e -n " ${WHITE}${title}${CYAN} "
    for ((i = 0; i < padding; i++)); do echo -n "${H}"; done
    if [ $(((width - title_len - 2) % 2)) -eq 1 ]; then
      echo -n "${H}"
    fi
  else
    for ((i = 0; i < width; i++)); do echo -n "${H}"; done
  fi
  echo -e "${TR}${NC}"
}

draw_box_bottom() {
  local width=$1
  echo -e -n "${CYAN}${BL}"
  for ((i = 0; i < width; i++)); do echo -n "${H}"; done
  echo -e "${BR}${NC}"
}

box_line() {
  echo -e "${CYAN}${V}${NC} $1"
}

print_status() {
  local status=$1
  local message=$2

  case $status in
  "ok")
    echo -e "${GREEN}✓${NC} $message"
    ;;
  "warn")
    echo -e "${YELLOW}⚠ ${NC} $message"
    ;;
  "error")
    echo -e "${RED}✗${NC} $message"
    ;;
  "info")
    echo -e "${BLUE}ℹ${NC} $message"
    ;;
  "fix")
    echo -e "${GREEN}⚡${NC} $message"
    ;;
  esac
}

wait_key() {
  echo ""
  echo -e "${GRAY}Press Enter to continue...${NC}"
  read -r
}

# ============================================================================
# SYSTEM CHECKS
# ============================================================================

check_root() {
  if [ "$EUID" -ne 0 ]; then
    echo -e "${YELLOW}Imaginary Angel requires root privileges${NC}"
    echo "Requesting sudo access..."
    exec sudo "$0" "$@"
  fi
}

init_directories() {
  mkdir -p "$LOG_DIR"
  mkdir -p "$CACHE_DIR"

  if [ ! -f "$CONFIG_FILE" ]; then
    cat >"$CONFIG_FILE" <<'EOF'
# Imaginary Angel Configuration
AUTO_FIX=false
LOG_RETENTION_DAYS=30
ALERT_THRESHOLD_CPU=80
ALERT_THRESHOLD_MEM=85
ALERT_THRESHOLD_DISK=90
SUSPICIOUS_PROCESS_CHECK=true
NETWORK_ANOMALY_DETECTION=true
EOF
  fi
}

load_modules() {
  if [ ! -d "$MODULES_DIR" ]; then
    echo -e "${RED}Error: Modules directory not found: $MODULES_DIR${NC}"
    echo "Make sure to keep the 'modules' folder with this script."
    exit 1
  fi

  # Source all module files
  for module in "$MODULES_DIR"/*.sh; do
    if [ -f "$module" ]; then
      source "$module"
    fi
  done
}

# ============================================================================
# MAIN MENU
# ============================================================================

show_main_menu() {
  print_logo

  draw_box 56 "MAIN MENU"
  box_line ""
  box_line "  ${CYAN}1${NC}) System Health & Auto-Repair"
  box_line "  ${CYAN}2${NC}) Security Audit & Hardening"
  box_line "  ${CYAN}3${NC}) Network Threat Detection"
  box_line "  ${CYAN}4${NC}) Process Analysis & Cleanup"
  box_line "  ${CYAN}5${NC}) System Integrity & Recovery"
  box_line "  ${CYAN}6${NC}) Package Management & Updates"
  box_line "  ${CYAN}7${NC}) Service Management & Optimization"
  box_line "  ${CYAN}8${NC}) System Reports & Diagnostics"
  box_line "  ${CYAN}9${NC}) Configuration"
  box_line ""
  box_line "  ${CYAN}0${NC}) Exit"
  box_line ""
  draw_box_bottom 56

  echo ""
  echo -e -n "${WHITE}Select option:${NC} "
  read -r choice

  case $choice in
  1) system_health_check ;;
  2) security_audit ;;
  3) network_threat_detection ;;
  4) process_analysis ;;
  5) integrity_check ;;
  6) package_manager ;;
  7) service_manager ;;
  8) system_reports ;;
  9) configuration_menu ;;
  0)
    echo ""
    echo -e "${CYAN}Thank you for using Imaginary Angel!${NC}"
    sleep 3
    clear
    exit 0
    ;;
  *)
    echo -e "${RED}Invalid option${NC}"
    sleep 1
    show_main_menu
    ;;
  esac
}

# ============================================================================
# CONFIGURATION MENU
# ============================================================================

configuration_menu() {
  print_logo
  draw_box 60 "CONFIGURATION"
  echo ""

  # Load current config
  if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
  fi

  # Set defaults
  AUTO_FIX=${AUTO_FIX:-false}
  ALERT_THRESHOLD_CPU=${ALERT_THRESHOLD_CPU:-80}
  ALERT_THRESHOLD_MEM=${ALERT_THRESHOLD_MEM:-85}
  ALERT_THRESHOLD_DISK=${ALERT_THRESHOLD_DISK:-90}

  box_line "Current Settings:"
  box_line ""
  box_line "  Auto-Fix Issues: ${AUTO_FIX}"
  box_line "  CPU Alert Threshold: ${ALERT_THRESHOLD_CPU}%"
  box_line "  Memory Alert Threshold: ${ALERT_THRESHOLD_MEM}%"
  box_line "  Disk Alert Threshold: ${ALERT_THRESHOLD_DISK}%"
  box_line ""
  box_line "${CYAN}1${NC}) Toggle Auto-Fix (currently: ${AUTO_FIX})"
  box_line "${CYAN}2${NC}) Set CPU Alert Threshold"
  box_line "${CYAN}3${NC}) Set Memory Alert Threshold"
  box_line "${CYAN}4${NC}) Set Disk Alert Threshold"
  box_line "${CYAN}5${NC}) Reset to Defaults"
  box_line "${CYAN}6${NC}) View Full Configuration File"
  box_line ""
  box_line "${CYAN}0${NC}) Back to Main Menu"
  box_line ""
  draw_box_bottom 60

  echo ""
  echo -e -n "${WHITE}Select option:${NC} "
  read -r choice

  case $choice in
  1)
    if [ "$AUTO_FIX" = "true" ]; then
      sed -i 's/^AUTO_FIX=true/AUTO_FIX=false/' "$CONFIG_FILE"
      echo ""
      print_status "info" "Auto-fix disabled"
    else
      sed -i 's/^AUTO_FIX=false/AUTO_FIX=true/' "$CONFIG_FILE"
      echo ""
      print_status "info" "Auto-fix enabled"
    fi
    sleep 2
    configuration_menu
    ;;
  2)
    echo ""
    echo -e "${WHITE}Enter new CPU threshold % (current: ${ALERT_THRESHOLD_CPU}):${NC} "
    read -r cpu_thresh
    if [[ "$cpu_thresh" =~ ^[0-9]+$ ]] && [ "$cpu_thresh" -ge 1 ] && [ "$cpu_thresh" -le 100 ]; then
      sed -i "s/ALERT_THRESHOLD_CPU=.*/ALERT_THRESHOLD_CPU=${cpu_thresh}/" "$CONFIG_FILE"
      print_status "ok" "CPU threshold set to ${cpu_thresh}%"
    else
      print_status "error" "Invalid value. Must be between 1-100"
    fi
    sleep 2
    configuration_menu
    ;;
  3)
    echo ""
    echo -e "${WHITE}Enter new Memory threshold % (current: ${ALERT_THRESHOLD_MEM}):${NC} "
    read -r mem_thresh
    if [[ "$mem_thresh" =~ ^[0-9]+$ ]] && [ "$mem_thresh" -ge 1 ] && [ "$mem_thresh" -le 100 ]; then
      sed -i "s/ALERT_THRESHOLD_MEM=.*/ALERT_THRESHOLD_MEM=${mem_thresh}/" "$CONFIG_FILE"
      print_status "ok" "Memory threshold set to ${mem_thresh}%"
    else
      print_status "error" "Invalid value. Must be between 1-100"
    fi
    sleep 2
    configuration_menu
    ;;
  4)
    echo ""
    echo -e "${WHITE}Enter new Disk threshold % (current: ${ALERT_THRESHOLD_DISK}):${NC} "
    read -r disk_thresh
    if [[ "$disk_thresh" =~ ^[0-9]+$ ]] && [ "$disk_thresh" -ge 1 ] && [ "$disk_thresh" -le 100 ]; then
      sed -i "s/ALERT_THRESHOLD_DISK=.*/ALERT_THRESHOLD_DISK=${disk_thresh}/" "$CONFIG_FILE"
      print_status "ok" "Disk threshold set to ${disk_thresh}%"
    else
      print_status "error" "Invalid value. Must be between 1-100"
    fi
    sleep 2
    configuration_menu
    ;;
  5)
    echo ""
    echo -e -n "${YELLOW}Reset all settings to defaults? (y/N):${NC} "
    read -r confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      cat >"$CONFIG_FILE" <<'EOF'
# Imaginary Angel Configuration
AUTO_FIX=false
LOG_RETENTION_DAYS=30
ALERT_THRESHOLD_CPU=80
ALERT_THRESHOLD_MEM=85
ALERT_THRESHOLD_DISK=90
SUSPICIOUS_PROCESS_CHECK=true
NETWORK_ANOMALY_DETECTION=true
EOF
      print_status "ok" "Configuration reset to defaults"
    fi
    sleep 2
    configuration_menu
    ;;
  6)
    echo ""
    cat "$CONFIG_FILE"
    echo ""
    echo -e "${GRAY}Press Enter to continue...${NC}"
    read -r
    configuration_menu
    ;;
  0) show_main_menu ;;
  *)
    echo -e "${RED}Invalid option${NC}"
    sleep 1
    configuration_menu
    ;;
  esac
}

# ============================================================================
# MAIN
# ============================================================================

main() {
  check_root
  init_directories
  load_modules
  show_main_menu
}

# Run main function
main "$@"
